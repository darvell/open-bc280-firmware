#include "ui_font.h"

#include <stddef.h>

#ifndef UI_FONT_GLYPH_W
#define UI_FONT_GLYPH_W 5u
#endif
#ifndef UI_FONT_GLYPH_H
#define UI_FONT_GLYPH_H 7u
#endif

typedef struct {
    char c;
    uint8_t rows[UI_FONT_GLYPH_H];
} ui_font_glyph_t;

static const ui_font_glyph_t k_font_glyphs[] = {
    {'?', {0x0Eu, 0x11u, 0x02u, 0x04u, 0x04u, 0x00u, 0x04u}},
    {' ', {0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {'0', {0x0Eu, 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x0Eu}},
    {'1', {0x04u, 0x0Cu, 0x04u, 0x04u, 0x04u, 0x04u, 0x0Eu}},
    {'2', {0x0Eu, 0x11u, 0x01u, 0x02u, 0x04u, 0x08u, 0x1Fu}},
    {'3', {0x0Eu, 0x11u, 0x01u, 0x06u, 0x01u, 0x11u, 0x0Eu}},
    {'4', {0x02u, 0x06u, 0x0Au, 0x12u, 0x1Fu, 0x02u, 0x02u}},
    {'5', {0x1Fu, 0x10u, 0x1Eu, 0x01u, 0x01u, 0x11u, 0x0Eu}},
    {'6', {0x06u, 0x08u, 0x10u, 0x1Eu, 0x11u, 0x11u, 0x0Eu}},
    {'7', {0x1Fu, 0x01u, 0x02u, 0x04u, 0x08u, 0x08u, 0x08u}},
    {'8', {0x0Eu, 0x11u, 0x11u, 0x0Eu, 0x11u, 0x11u, 0x0Eu}},
    {'9', {0x0Eu, 0x11u, 0x11u, 0x0Fu, 0x01u, 0x02u, 0x0Cu}},
    {'A', {0x0Eu, 0x11u, 0x11u, 0x1Fu, 0x11u, 0x11u, 0x11u}},
    {'B', {0x1Eu, 0x11u, 0x11u, 0x1Eu, 0x11u, 0x11u, 0x1Eu}},
    {'C', {0x0Eu, 0x11u, 0x10u, 0x10u, 0x10u, 0x11u, 0x0Eu}},
    {'D', {0x1Eu, 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x1Eu}},
    {'E', {0x1Fu, 0x10u, 0x10u, 0x1Eu, 0x10u, 0x10u, 0x1Fu}},
    {'F', {0x1Fu, 0x10u, 0x10u, 0x1Eu, 0x10u, 0x10u, 0x10u}},
    {'G', {0x0Eu, 0x11u, 0x10u, 0x17u, 0x11u, 0x11u, 0x0Eu}},
    {'H', {0x11u, 0x11u, 0x11u, 0x1Fu, 0x11u, 0x11u, 0x11u}},
    {'I', {0x0Eu, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x0Eu}},
    {'J', {0x01u, 0x01u, 0x01u, 0x01u, 0x11u, 0x11u, 0x0Eu}},
    {'K', {0x11u, 0x12u, 0x14u, 0x18u, 0x14u, 0x12u, 0x11u}},
    {'L', {0x10u, 0x10u, 0x10u, 0x10u, 0x10u, 0x10u, 0x1Fu}},
    {'M', {0x11u, 0x1Bu, 0x15u, 0x15u, 0x11u, 0x11u, 0x11u}},
    {'N', {0x11u, 0x19u, 0x15u, 0x13u, 0x11u, 0x11u, 0x11u}},
    {'O', {0x0Eu, 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x0Eu}},
    {'P', {0x1Eu, 0x11u, 0x11u, 0x1Eu, 0x10u, 0x10u, 0x10u}},
    {'Q', {0x0Eu, 0x11u, 0x11u, 0x11u, 0x15u, 0x12u, 0x0Du}},
    {'R', {0x1Eu, 0x11u, 0x11u, 0x1Eu, 0x14u, 0x12u, 0x11u}},
    {'S', {0x0Fu, 0x10u, 0x10u, 0x0Eu, 0x01u, 0x01u, 0x1Eu}},
    {'T', {0x1Fu, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x04u}},
    {'U', {0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x0Eu}},
    {'V', {0x11u, 0x11u, 0x11u, 0x11u, 0x11u, 0x0Au, 0x04u}},
    {'W', {0x11u, 0x11u, 0x11u, 0x15u, 0x15u, 0x15u, 0x0Au}},
    {'X', {0x11u, 0x11u, 0x0Au, 0x04u, 0x0Au, 0x11u, 0x11u}},
    {'Y', {0x11u, 0x11u, 0x0Au, 0x04u, 0x04u, 0x04u, 0x04u}},
    {'Z', {0x1Fu, 0x01u, 0x02u, 0x04u, 0x08u, 0x10u, 0x1Fu}},
    {'.', {0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x06u, 0x06u}},
    {',', {0x00u, 0x00u, 0x00u, 0x00u, 0x06u, 0x06u, 0x04u}},
    {':', {0x00u, 0x06u, 0x06u, 0x00u, 0x06u, 0x06u, 0x00u}},
    {'-', {0x00u, 0x00u, 0x00u, 0x1Fu, 0x00u, 0x00u, 0x00u}},
    {'_', {0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u, 0x1Fu}},
    {'/', {0x01u, 0x02u, 0x04u, 0x08u, 0x10u, 0x00u, 0x00u}},
    {'%', {0x19u, 0x1Au, 0x04u, 0x08u, 0x16u, 0x06u, 0x00u}},
    {'+', {0x00u, 0x04u, 0x04u, 0x1Fu, 0x04u, 0x04u, 0x00u}},
    {'(', {0x02u, 0x04u, 0x08u, 0x08u, 0x08u, 0x04u, 0x02u}},
    {')', {0x08u, 0x04u, 0x02u, 0x02u, 0x02u, 0x04u, 0x08u}},
    {'[', {0x0Eu, 0x08u, 0x08u, 0x08u, 0x08u, 0x08u, 0x0Eu}},
    {']', {0x0Eu, 0x02u, 0x02u, 0x02u, 0x02u, 0x02u, 0x0Eu}},
    {'!', {0x04u, 0x04u, 0x04u, 0x04u, 0x04u, 0x00u, 0x04u}},
    {'=', {0x00u, 0x1Fu, 0x00u, 0x1Fu, 0x00u, 0x00u, 0x00u}},
    {'#', {0x0Au, 0x0Au, 0x1Fu, 0x0Au, 0x1Fu, 0x0Au, 0x0Au}},
    {'*', {0x00u, 0x0Au, 0x04u, 0x1Fu, 0x04u, 0x0Au, 0x00u}},
    {'"', {0x0Au, 0x0Au, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {'\'', {0x04u, 0x04u, 0x00u, 0x00u, 0x00u, 0x00u, 0x00u}},
    {'<', {0x02u, 0x04u, 0x08u, 0x10u, 0x08u, 0x04u, 0x02u}},
    {'>', {0x08u, 0x04u, 0x02u, 0x01u, 0x02u, 0x04u, 0x08u}},
};

static const ui_font_glyph_t *ui_font_find_glyph(char c)
{
    if (c >= 'a' && c <= 'z')
        c = (char)(c - 'a' + 'A');

    for (size_t i = 0; i < sizeof(k_font_glyphs) / sizeof(k_font_glyphs[0]); ++i)
    {
        if (k_font_glyphs[i].c == c)
            return &k_font_glyphs[i];
    }
    return &k_font_glyphs[0];
}

void ui_font_draw_char(void (*set_px)(int x, int y, uint16_t color, void *user),
                       void *user,
                       char c,
                       int x,
                       int y,
                       uint16_t color)
{
    if (!set_px)
        return;
    const ui_font_glyph_t *glyph = ui_font_find_glyph(c);
    if (!glyph)
        return;
    if (glyph->c == ' ')
        return;

    for (uint8_t row = 0; row < UI_FONT_GLYPH_H; ++row)
    {
        uint8_t bits = glyph->rows[row];
        for (uint8_t col = 0; col < UI_FONT_GLYPH_W; ++col)
        {
            uint8_t mask = (uint8_t)(1u << (UI_FONT_GLYPH_W - 1u - col));
            if (bits & mask)
                set_px(x + (int)col, y + (int)row, color, user);
        }
    }
}

void ui_font_draw_text(void (*set_px)(int x, int y, uint16_t color, void *user),
                       void *user,
                       int x,
                       int y,
                       const char *text,
                       uint16_t color)
{
    if (!set_px || !text)
        return;
    int cursor_x = x;
    int cursor_y = y;

    for (const char *p = text; *p; ++p)
    {
        char c = *p;
        if (c == '\n')
        {
            cursor_y += (int)UI_FONT_ADV_Y;
            cursor_x = x;
            continue;
        }
        ui_font_draw_char(set_px, user, c, cursor_x, cursor_y, color);
        cursor_x += (int)UI_FONT_ADV_X;
    }
}
