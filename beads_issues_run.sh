#!/usr/bin/env bash
set -euo pipefail

PROMPT=$'You are running inside the open-bc280-firmware repository as an automated coding agent.\n\nYour job is to fully complete exactly ONE ready bd issue per run for the BC280 open firmware, verify it (Renode-first, hardware only if required), close it, commit the changes, and then exit.\n\nFollow this process strictly:\n\n1) Select a single issue\n   - Run `bd ready --json` and choose the highest-priority non-epic issue deterministically (lowest numeric priority; ignore issues where `issue_type` is "epic").\n   - Use `bd show <id> --json` to read its `description`, `design`, `acceptance_criteria`, and `notes`.\n\n2) Claim it in bd\n   - Immediately mark it in progress and assign it to yourself:\n     - `bd update <id> --status in_progress --assignee "$USER" --notes "Automated agent started work on this issue." --json`\n\n3) Understand context and constraints\n   - Read `AGENTS.md`, `open-firmware/README.md`, and any files referenced in the issue notes.\n   - Repository rules: preserve OEM binaries; do NOT modify/replace the OEM bootloader; open-firmware must stay self-contained (no linking against OEM images); keep the bootloader jump/validation path intact (boot flag at 0x0030_0000+0x3FF080, app at 0x0801_0000).\n   - Prefer Renode-first workflows; Aventon BC280 variants are the primary target. Use paths mentioned in the issue notes (e.g., `open-firmware/`, `scripts/`, `firmware/` as references) as the starting points.\n\n4) Plan and implement the change\n   - Form a brief internal plan of steps.\n   - Use repo tooling: `rg`/`fd` for search, `apply_patch` for edits, and existing scripts (e.g., under `scripts/` or `open-firmware/renode/`) where possible.\n   - Keep changes tightly scoped to the issue; do not fix unrelated problems unless they block you.\n\n5) Validate with appropriate feedback loops\n   - Prefer Renode emulation and the smallest targeted builds/tests relevant to the change (e.g., `make -C open-firmware` or issue-referenced scripts).\n   - If hardware validation is required by acceptance criteria, script the steps and run only what is necessary; otherwise leave clear instructions.\n   - Proceed to closing only once all acceptance criteria are satisfied.\n\n6) Record what you did (leave a note)\n   - Leave a concise bd note before closing:\n     - What you changed (files/components), and\n     - Which builds/tests you ran and their results.\n\n7) Close the issue and commit\n   - Close the issue when done:\n     - `bd close <id> --reason "Completed" --json`\n   - Review changes with `git status` and `git diff`.\n   - Commit with a message that includes the issue id and a concise summary, for example:\n     - `git commit -am "open-bc280-<id>: <concise summary>"`\n\n8) Optional: spawn sub-agents for clearly independent subtasks\n   - Only for narrow, disjoint work items (e.g., a small script or doc tweak); avoid conflicts.\n   - Example sub-agent invocation:\n     - `codex exec -m gpt-5.1-codex-max --config model_reasoning_effort="high" -s danger-full-access $\'You are a coding subagent. Implement the Renode test harness described in issue <id> under open-firmware/renode/, run relevant checks, then exit.\'`\n   - Never spawn sub-agents that re-run this loop.\n\n9) Exit after one issue\n   - After you have:\n     - Marked the issue in progress,\n     - Implemented the change,\n     - Validated it,\n     - Updated bd notes,\n     - Closed the issue, and\n     - Committed the changes,\n   - STOP. Do not pick up a second issue within this run. Exit and let the outer script dispatch the next agent for the next ready issue.\n'

while true; do
  ready_json="$(bd ready --json)"
  issue_count="$(printf '%s' "$ready_json" | jq 'length')"

  if [[ "$issue_count" -eq 0 ]]; then
    echo "No ready issues remaining."
    break
  fi

  echo "Issues remaining: $issue_count â€” dispatching subagent..."
  codex exec -m gpt-5.2-codex --config model_reasoning_effort="medium" -s danger-full-access "$PROMPT"

done
